<VirtualHost *:443>
    # Global server information (replace [EXAMPLE.COM] with your own domain)
    ServerName [EXAMPLE.COM]
    ServerAdmin webmaster@localhost
    
    # SSL configuration using Let's Encrypt (replace [EXAMPLE.COM] with your own domain)
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/[EXAMPLE.COM]/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/[EXAMPLE.COM]/privkey.pem
    Include /etc/letsencrypt/options-ssl-apache.conf
    
    # Logging configuration
    ErrorLog ${APACHE_LOG_DIR}/error.log
    CustomLog ${APACHE_LOG_DIR}/access.log combined
    
    # Basic configuration
    DocumentRoot /var/www/html

    <Directory /var/www/html>
        Options Indexes FollowSymLinks
        AllowOverride None
        Require all granted
    </Directory>

    Alias /.well-known /var/www/html/json_files

    <Location "/.well-known/com.apple.remotemanagement">
        SetHandler none
    </Location>

    # Rewrite URL depending on device type (Mac, iPhone, iPad, Watch, AppleTV, RealityDevice)
    RewriteEngine On
    
    # Set Account Driven enrollment type for Mac computers
    RewriteCond %{QUERY_STRING} model-family=Mac
    RewriteRule ^/.well-known/com.apple.remotemanagement$ /.well-known/adde.json [L]
    
    # Set Account Driven enrollment type for iPhone
    RewriteCond %{QUERY_STRING} model-family=iPhone
    RewriteRule ^/.well-known/com.apple.remotemanagement$ /.well-known/byod.json [L]
    
    # Set Account Driven enrollment type for iPad
    RewriteCond %{QUERY_STRING} model-family=iPad
    RewriteRule ^/.well-known/com.apple.remotemanagement$ /.well-known/byod.json [L]

    # Set Account Driven enrollment type for Vision Pro
    RewriteCond %{QUERY_STRING} model-family=RealityDevice
    RewriteRule ^/.well-known/com.apple.remotemanagement$ /.well-known/adde.json [L]
    
    # Catch all rule for other device types
    RewriteRule ^/.well-known/com.apple.remotemanagement$ /.well-known/adde.json [L]
</VirtualHost>
